# 架构决策：职责边界与数据源 (SSOT)

**日期**: 2025-12-01
**状态**: 已接受
**背景**: 项目 "Template Maintenance"、"Prometheus Agent" 交互以及 "Virtual Team" 编排。

## 1. 问题陈述 (重复定义与上下文污染)
我们识别出系统架构中存在潜在的冗余和维护风险：
1.  **Rule 层** (`.mdc`): 原本用于定义触发器，但常常包含了过多的工作流描述。
2.  **Pattern 层** (`.md`): 定义了详细的工作流，但缺乏与 Rule 的明确连接机制。
3.  **Agent 层** (`capabilities/*.md`): 定义了具体角色的能力，但不知道如何与其他角色协作。

**风险**: 如果 Pattern 中的工作流发生变更（SSOT），Rule 中的摘要和 Agent 的指令可能会过时，导致模型执行混乱。

## 2. 决策 (关注点分离)

我们明确定义了 **Prometheus 架构** 中各层的职责边界：

### 第一层：路由器 (The Router / Rule Layer)
*   **文件位置**: `.cursor/rules/teams/*.mdc`
*   **隐喻**: **前台接待员 / 调度员**。
*   **职责**: **仅负责流量控制**。它不解决问题，只负责找到能解决问题的人。
*   **核心动作**:
    1.  **监听 (Listen)**: 通过 Globs 监听特定文件变更或用户意图。
    2.  **路由 (Route)**: 查阅简易的 "路由表" (Decision Matrix)。
    3.  **加载 (Load)**: 强制执行 `read_file` 指令，加载下一层的 Pattern 或 Capability 文件。
*   **禁忌**: 严禁在 Rule 中定义详细的步骤 (Step-by-Step)。
*   **内容策略**: 仅包含 **触发条件**、**简易路由表** 和 **加载指令**。

### 第二层：内核 (The Kernel / Pattern Layer)
*   **文件位置**: `prompts-library/templates/patterns/*.md`
*   **隐喻**: **团队宪法 / 作战手册**。
*   **职责**: **编排的唯一真理源 (SSOT)**。
*   **核心动作**:
    1.  **定义团队 (Team Roster)**: 引用具体的 Capabilities 文件 (Who)。
    2.  **定义协议 (Protocols)**: 规定角色间的交互顺序 (When & How)。
    3.  **共享上下文 (Shared Context)**: 提供项目背景、全局约束。
*   **关键点**: Pattern 文件不包含角色的具体执行逻辑，只包含角色间的**协作逻辑**。

### 第三层：执行者 (The Worker / Agent Layer)
*   **文件位置**: `prompts-library/templates/capabilities/*.md`
*   **隐喻**: **专科医生 / 工匠**。
*   **职责**: **具体领域的执行逻辑**。
*   **核心动作**:
    1.  **接受任务**: 从 Pattern 接收上下文。
    2.  **执行任务**: 运用专业知识（如 Python 编码、Prompt 编写）生成产物。
    3.  **交付产物**: 输出代码、文档或建议。
*   **独立性**: Agent 不知道自己属于哪个 Team，它只知道如何干好自己的活。是 Pattern 把它编排进了 Team。

## 3. 案例分析：虚拟 Streamlit 团队

| 特性 | Pattern 文件 (`.md`) | Rule 文件 (`.mdc`) |
| :--- | :--- | :--- |
| **角色定位** | **宪法 (内核)** | **接待员 (钩子)** |
| **核心目标** | 定义 *团队结构* 和 *协作协议*。 | 识别意图并 *挂载* 对应 Pattern。 |
| **触发机制** | 无 (被动引用)。 | **Globs** (`**/*.py`) & 关键词触发。 |
| **决策矩阵** | 完整定义 (包含原理 & 深度逻辑)。 | **路由表** (仅包含 Signal -> Action)。 |
| **工作流定义** | **详细协议** (Protocol A/B/C/D)。 | **指针引用** (例如: "执行 Pattern 中的 Protocol A")。 |
| **维护频率** | **高** (业务逻辑变更时修改)。 | **低** (仅在路由规则变更时修改)。 |

## 4. 实施指南

### 对于 Rule 编写者
*   **保持轻量**: 如果 `.mdc` 文件超过 50 行，请检查是否有逻辑泄露。
*   **显式加载**: 必须包含 `read_file: prompts-library/templates/patterns/[team].md` 的指令。

### 对于 Pattern 编写者
*   **引用而非定义**: 不要把 Capability 的内容复制进来，使用链接或路径引用。
*   **编排优先**: 重点描述角色 A 如何把结果传递给角色 B。

## 5. 结果
*   (+) **可维护性**: 修改工作流只需改动 Pattern 文件。
*   (+) **Token 效率**: 只有在触发 Rule 后，才加载庞大的 Pattern 上下文。
*   (-) **间接性**: 用户（和模型）需要多跳一步才能看到完整逻辑（通过工具调用解决）。
